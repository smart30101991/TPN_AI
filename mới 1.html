<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªó tr·ª£ Dinh d∆∞·ª°ng S∆° sinh (PN/EN) v2</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* S·ª≠ d·ª•ng font Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        /* T√πy ch·ªânh thanh cu·ªôn */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Gi√∫p input number hi·ªÉn th·ªã t·ªët h∆°n */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Th√™m style cho loading spinner c·ªßa AI */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-blue-800">B·∫£ng t√≠nh H·ªó tr·ª£ Dinh d∆∞·ª°ng S∆° sinh (PN/EN)</h1>
            <p class="text-lg text-gray-600">C√¥ng c·ª• t√≠nh to√°n (c√≥ h·ªó tr·ª£ c·ªßa Gemini AI) k·∫øt h·ª£p Nu√¥i ƒÉn Tƒ©nh m·∫°ch (PN) v√† Ti√™u h√≥a (EN).</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- C·ªòT 1: NH·∫¨P LI·ªÜU -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Th√¥ng tin B·ªánh nh√¢n -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">1. Th√¥ng tin B·ªánh nh√¢n</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="weight" class="block text-sm font-medium text-gray-700">C√¢n n·∫∑ng (kg)</label>
                            <input type="number" id="weight" step="0.1" value="1.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="patientType" class="block text-sm font-medium text-gray-700">ƒê·ªëi t∆∞·ª£ng</label>
                            <select id="patientType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="preterm">Sinh non</option>
                                <option value="term">Sinh ƒë·ªß th√°ng</option>
                            </select>
                        </div>
                        <div>
                            <label for="ivLine" class="block text-sm font-medium text-gray-700">ƒê∆∞·ªùng truy·ªÅn</label>
                            <select id="ivLine" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="peripheral">Tƒ©nh m·∫°ch Ngo·∫°i vi</option>
                                <option value="central">Tƒ©nh m·∫°ch Trung t√¢m</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- M·ª•c ti√™u Dinh d∆∞·ª°ng -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">2. M·ª•c ti√™u Dinh d∆∞·ª°ng (T·ªïng EN + PN)</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="targetFluid" class="block text-sm font-medium text-gray-700">T·ªïng d·ªãch (ml/kg/ng√†y)</label>
                            <input type="number" id="targetFluid" value="120" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="targetEnergy" class="block text-sm font-medium text-gray-700">NƒÉng l∆∞·ª£ng (kcal/kg/ng√†y)</label>
                            <input type="number" id="targetEnergy" value="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="targetProtein" class="block text-sm font-medium text-gray-700">Protein (g/kg/ng√†y)</label>
                            <input type="number" id="targetProtein" step="0.1" value="3.0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="targetLipid" class="block text-sm font-medium text-gray-700">Lipid (g/kg/ng√†y)</label>
                            <input type="number" id="targetLipid" step="0.1" value="3.0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Nu√¥i ƒÉn Ti√™u h√≥a (EN) -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">3. Nu√¥i ƒÉn Ti√™u h√≥a (EN)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="milkType" class="block text-sm font-medium text-gray-700">Lo·∫°i s·ªØa</label>
                            <select id="milkType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="S1">S·ªØa ƒë·ªß th√°ng (S1)</option>
                                <option value="SN" selected>S·ªØa sinh non (SN)</option>
                                <option value="SDB">S·ªØa ƒë·∫∑c bi·ªát (SDB)</option>
                                <option value="STP">S·ªØa th·ªßy ph√¢n (STP)</option>
                            </select>
                        </div>
                        <div>
                            <label for="enVolume" class="block text-sm font-medium text-gray-700">Th·ªÉ t√≠ch EN (ml/kg/ng√†y)</label>
                            <input type="number" id="enVolume" value="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Nhu c·∫ßu ƒêi·ªán gi·∫£i (PN) -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">4. Nhu c·∫ßu ƒêi·ªán gi·∫£i (cho PN)</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="targetNa" class="block text-sm font-medium text-gray-700">Natri (mEq/kg/ng√†y)</label>
                            <input type="number" id="targetNa" step="0.1" value="2.0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="targetK" class="block text-sm font-medium text-gray-700">Kali (mEq/kg/ng√†y)</label>
                            <input type="number" id="targetK" step="0.1" value="1.0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="targetCa" class="block text-sm font-medium text-gray-700">Calci (mEq/kg/ng√†y)</label>
                            <input type="number" id="targetCa" step="0.1" value="1.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="targetP" class="block text-sm font-medium text-gray-700">Phospho (mmol/kg/ng√†y)</label>
                            <input type="number" id="targetP" step="0.1" value="0.0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- N√∫t T√≠nh to√°n -->
                <button id="calculateBtn" class="w-full text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 py-3 px-6 rounded-lg shadow-md transition duration-200">
                    T√≠nh to√°n Th√†nh ph·∫ßn Dinh d∆∞·ª°ng
                </button>
            </div>

            <!-- C·ªòT 2: K·∫æT QU·∫¢ -->
            <div class="lg:col-span-1 space-y-6">
                <!-- C·∫£nh b√°o An to√†n -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">C·∫£nh b√°o An to√†n</h2>
                    <div id="alertsContainer" class="space-y-2">
                        <p class="text-gray-500">Ch∆∞a c√≥ c·∫£nh b√°o.</p>
                        <!-- C·∫£nh b√°o s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·∫±ng JavaScript -->
                    </div>
                </div>

                <!-- *** M·ªöI: Th√™m Card Ph√¢n t√≠ch AI *** -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Ph√¢n t√≠ch c·ªßa AI (Gemini)</h2>
                    <button id="analyzeBtn" class="w-full text-md font-semibold text-white bg-indigo-500 hover:bg-indigo-600 focus:ring-4 focus:ring-indigo-300 py-2 px-4 rounded-lg shadow-md transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        Nh·∫≠n Ph√¢n t√≠ch t·ª´ AI
                    </button>
                    <div id="aiAnalysisResult" class="mt-4 p-3 bg-gray-50 rounded-lg min-h-[100px] text-gray-700">
                        <p class="text-gray-500 italic">Ch·∫°y t√≠nh to√°n ƒë·ªÉ k√≠ch ho·∫°t ph√¢n t√≠ch AI.</p>
                    </div>
                </div>


                <!-- T·ªïng k·∫øt Dinh d∆∞·ª°ng -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">T·ªïng k·∫øt Dinh d∆∞·ª°ng (ƒê·∫°t ƒë∆∞·ª£c)</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">T·ªïng d·ªãch:</span>
                            <span id="resTotalFluid" class="font-bold text-lg text-blue-700">0 ml/kg/ng√†y</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">T·ªïng NƒÉng l∆∞·ª£ng:</span>
                            <span id="resTotalEnergy" class="font-bold text-lg text-blue-700">0 kcal/kg/ng√†y</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">T·ªïng Protein:</span>
                            <span id="resTotalProtein" class="font-bold text-lg text-blue-700">0 g/kg/ng√†y</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">T·ªïng Lipid:</span>
                            <span id="resTotalLipid" class="font-bold text-lg text-blue-700">0 g/kg/ng√†y</span>
                        </div>
                        <hr class="my-3">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">T·ªëc ƒë·ªô truy·ªÅn Glucose (GIR):</span>
                            <span id="resGIR" class="font-bold text-lg text-red-600">0 mg/kg/ph√∫t</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">N·ªìng ƒë·ªô Dextrose (PN):</span>
                            <span id="resDextroseConc" class="font-bold text-lg text-red-600">0 %</span>
                        </div>
                    </div>
                </div>

                <!-- Th√†nh ph·∫ßn Pha (PN) -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Th√†nh ph·∫ßn Pha (cho 24h) - D·ªäCH PHA V√Ä LIPID RI√äNG BI·ªÜT</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center bg-blue-50 p-2 rounded-md">
                            <span class="font-bold text-blue-800">T·ªïng d·ªãch pha (Kh√¥ng Lipid):</span>
                            <span id="resPnTotalVolume" class="font-bold text-lg text-blue-800">0 ml</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Amino Acid 6.5%:</span>
                            <span id="resAminoAcidML" class="font-medium text-gray-900">0 ml</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Dextrose 10%:</span>
                            <span id="resDextrose10ML" class="font-medium text-gray-900">0 ml</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Dextrose 30%:</span>
                            <span id="resDextrose30ML" class="font-medium text-gray-900">0 ml</span>
                        </div>
                        <hr class="my-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Natri Clorua 10%:</span>
                            <span id="resNaML" class="font-medium text-gray-900">0 ml</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Kali Clorua 10%:</span>
                            <span id="resKML" class="font-medium text-gray-900">0 ml</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Calci Gluconate 10%:</span>
                            <span id="resCaML" class="font-medium text-gray-900">0 ml</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">Phosphorus Aguettant:</span>
                            <span id="resPML" class="font-medium text-gray-900">0 ml</span>
                        </div>
                    </div>

                    <!-- T√°ch ri√™ng Lipid -->
                    <div class="mt-4 pt-4 border-t">
                        <h3 class="font-semibold text-gray-800 mb-2">Truy·ªÅn Lipid (Ri√™ng)</h3>
                        <div class="flex justify-between items-center bg-yellow-50 p-2 rounded-md">
                            <span class="font-bold text-yellow-800">Lipid 20%:</span>
                            <span id="resLipidML_sep" class="font-bold text-lg text-yellow-800">0 ml</span>
                        </div>
                    </div>

                    <!-- T·ªëc ƒë·ªô truy·ªÅn -->
                    <div class="mt-4 pt-4 border-t">
                        <h3 class="font-semibold text-gray-800 mb-2">T·ªëc ƒë·ªô truy·ªÅn (24h)</h3>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">T·ªëc ƒë·ªô D·ªãch pha:</span>
                            <span id="resRateSolution" class="font-medium text-gray-900">0 ml/gi·ªù</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">T·ªëc ƒë·ªô Lipid 20%:</span>
                            <span id="resRateLipid" class="font-medium text-gray-900">0 ml/gi·ªù</span>
                        </div>
                    </div>
                </div>

                <!-- Ph√¢n t√≠ch EN vs PN -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">Ph√¢n t√≠ch Chi ti·∫øt (ƒê∆°n v·ªã /kg/ng√†y)</h2>
                    <table class="w-full text-left table-fixed">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-2 font-medium text-gray-600">Th√†nh ph·∫ßn</th>
                                <th class="p-2 font-medium text-gray-600">T·ª´ EN</th>
                                <th class="p-2 font-medium text-gray-600">T·ª´ PN</th>
                                <th class="p-2 font-medium text-gray-600">T·ªïng</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="p-2 font-medium">NƒÉng l∆∞·ª£ng (kcal)</td>
                                <td class="p-2" id="sumEnKcal">0</td>
                                <td class="p-2" id="sumPnKcal">0</td>
                                <td class="p-2 font-bold" id="sumTotalKcal">0</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td class="p-2 font-medium">Protein (g)</td>
                                <td class="p-2" id="sumEnProtein">0</td>
                                <td class="p-2" id="sumPnProtein">0</td>
                                <td class="p-2 font-bold" id="sumTotalProtein">0</td>
                            </tr>
                            <tr>
                                <td class="p-2 font-medium">Lipid (g)</td>
                                <td class="p-2" id="sumEnLipid">0</td>
                                <td class="p-2" id="sumPnLipid">0</td>
                                <td class="p-2 font-bold" id="sumTotalLipid_g">0</td>
                            </tr>
                            <tr class="bg-gray-50">
                                <td class="p-2 font-medium">Dextrose (g)</td>
                                <td class="p-2" id="sumEnDextrose">0</td>
                                <td class="p-2" id="sumPnDextrose">0</td>
                                <td class="p-2 font-bold" id="sumTotalDextrose">0</td>
                            </tr>
                            <tr>
                                <td class="p-2 font-medium">T·ª∑ l·ªá NPE/Protein (kcal/g)</td>
                                <td class="p-2" id="sumEnRatio">0</td>
                                <td class="p-2" id="sumPnRatio">0</td>
                                <td class="p-2 font-bold" id="sumTotalRatio">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- C√ÅC H·∫∞NG S·ªê Y KHOA (T·ª™ FILE DOCX) ---
        const STOCK_SOLUTIONS = {
            AMINO_ACID: { conc: 0.065, kcal_per_g: 4 }, // 6.5%
            LIPID: { conc: 0.20, kcal_per_g: 9 },      // 20%
            DEXTROSE_10: { conc: 0.10, kcal_per_g: 3.4 },
            DEXTROSE_30: { conc: 0.30, kcal_per_g: 3.4 }
        };

        const ELECTROLYTES = {
            NA_CL: { mEq_per_ml: 1.7 }, // Natri Clorua 10%
            K_CL: { mEq_per_ml: 1.3 },  // Kali Clorua 10%
            CA_GLUCONATE: { mEq_per_ml: 0.45 }, // Calci Gluconate 10%
            PHOSPHORUS: { mmol_per_ml: 0.66, mEqNa_per_ml: 1.33 } // Phosphorus Aguettant
        };

        const MILK_TYPES = {
            // Dinh d∆∞·ª°ng/100ml s·ªØa
            S1: { protein: 1.05, kcal: 68 }, // S·ªØa ƒë·ªß th√°ng
            SN: { protein: 1.9, kcal: 74 },  // S·ªØa sinh non
            STP: { protein: 1.9, kcal: 68 }, // S·ªØa th·ªßy ph√¢n
            SDB: { protein: 2.4, kcal: 81.2 } // S·ªØa ƒë·∫∑c bi·ªát
        };

        const SAFETY_LIMITS = {
            MAX_GIR: 12,
            MAX_LIPID_G_PER_KG: 4.0, 
            MAX_PROTEIN_G_PER_KG_PRETERM: 3.5, 
            MAX_PROTEIN_G_PER_KG_TERM: 3.0, 
            MAX_AA_CONC_PERIPHERAL: 0.02, 
            MAX_DEX_CONC_PERIPHERAL: 0.125, // 12.5%
            MAX_DEX_CONC_CENTRAL: 0.25,   // 25%
            EN_STOP_PN_THRESHOLD: 100
        };

        // --- C√ÅC H·∫∞NG S·ªê API ---
        const apiKey = ""; // ƒê·ªÉ tr·ªëng, Canvas s·∫Ω t·ª± ƒë·ªông cung c·∫•p
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // --- L·∫§Y C√ÅC TH√ÄNH PH·∫¶N GIAO DI·ªÜN ---
        const btn = document.getElementById('calculateBtn');
        const alertsContainer = document.getElementById('alertsContainer');

        // Inputs
        const inWeight = document.getElementById('weight');
        const inPatientType = document.getElementById('patientType');
        const inIvLine = document.getElementById('ivLine');
        const inTargetFluid = document.getElementById('targetFluid');
        const inTargetEnergy = document.getElementById('targetEnergy');
        const inTargetProtein = document.getElementById('targetProtein');
        const inTargetLipid = document.getElementById('targetLipid');
        const inMilkType = document.getElementById('milkType');
        const inEnVolume = document.getElementById('enVolume');
        const inTargetNa = document.getElementById('targetNa');
        const inTargetK = document.getElementById('targetK');
        const inTargetCa = document.getElementById('targetCa');
        const inTargetP = document.getElementById('targetP'); 

        // Outputs
        const resTotalFluid = document.getElementById('resTotalFluid');
        const resTotalEnergy = document.getElementById('resTotalEnergy');
        const resTotalProtein = document.getElementById('resTotalProtein');
        const resTotalLipid = document.getElementById('resTotalLipid');
        const resGIR = document.getElementById('resGIR');
        const resDextroseConc = document.getElementById('resDextroseConc');
        const resPnTotalVolume = document.getElementById('resPnTotalVolume');
        const resAminoAcidML = document.getElementById('resAminoAcidML');
        const resDextrose10ML = document.getElementById('resDextrose10ML');
        const resDextrose30ML = document.getElementById('resDextrose30ML');
        const resNaML = document.getElementById('resNaML');
        const resKML = document.getElementById('resKML');
        const resCaML = document.getElementById('resCaML');
        const resPML = document.getElementById('resPML'); 
        
        const resLipidML_sep = document.getElementById('resLipidML_sep');
        const resRateSolution = document.getElementById('resRateSolution');
        const resRateLipid = document.getElementById('resRateLipid');
        
        // Summary Table
        const sumEnKcal = document.getElementById('sumEnKcal');
        const sumPnKcal = document.getElementById('sumPnKcal');
        const sumTotalKcal = document.getElementById('sumTotalKcal');
        const sumEnProtein = document.getElementById('sumEnProtein');
        const sumPnProtein = document.getElementById('sumPnProtein');
        const sumTotalProtein = document.getElementById('sumTotalProtein');
        
        const sumEnLipid = document.getElementById('sumEnLipid');
        const sumPnLipid = document.getElementById('sumPnLipid');
        const sumTotalLipid_g = document.getElementById('sumTotalLipid_g'); 
        const sumEnDextrose = document.getElementById('sumEnDextrose');
        const sumPnDextrose = document.getElementById('sumPnDextrose');
        const sumTotalDextrose = document.getElementById('sumTotalDextrose');
        const sumEnRatio = document.getElementById('sumEnRatio');
        const sumPnRatio = document.getElementById('sumPnRatio');
        const sumTotalRatio = document.getElementById('sumTotalRatio');

        // AI Elements
        const analyzeBtn = document.getElementById('analyzeBtn');
        const aiAnalysisResult = document.getElementById('aiAnalysisResult');


        // --- B·ªò N√ÉO T√çNH TO√ÅN ---
        btn.addEventListener('click', calculateNutrition);

        function calculateNutrition() {
            // 1. Kh·ªüi t·∫°o
            let alerts = [];
            
            // 2. ƒê·ªçc t·∫•t c·∫£ Input
            const weight = parseFloat(inWeight.value) || 0;
            if (weight <= 0) {
                alerts.push({ type: 'danger', message: 'C√¢n n·∫∑ng ph·∫£i l·ªõn h∆°n 0.' });
                updateAlerts(alerts); 
                return;
            }
            
            const patientType = inPatientType.value; 
            const ivLine = inIvLine.value;
            const milkType = MILK_TYPES[inMilkType.value];

            // ƒê·ªçc m·ª•c ti√™u (ƒë∆°n v·ªã /kg/ng√†y)
            const targetFluid_kg = parseFloat(inTargetFluid.value) || 0;
            const targetEnergy_kg = parseFloat(inTargetEnergy.value) || 0;
            let targetProtein_kg = parseFloat(inTargetProtein.value) || 0; 
            let targetLipid_kg = parseFloat(inTargetLipid.value) || 0; 
            const enVolume_kg = parseFloat(inEnVolume.value) || 0;
            const targetNa_kg = parseFloat(inTargetNa.value) || 0;
            const targetK_kg = parseFloat(inTargetK.value) || 0;
            const targetCa_kg = parseFloat(inTargetCa.value) || 0;
            const targetP_kg = parseFloat(inTargetP.value) || 0; 

            // √ÅP D·ª§NG GI·ªöI H·∫†N M·ªöI CHO PROTEIN V√Ä LIPID
            const max_protein_limit = (patientType === 'preterm') ? SAFETY_LIMITS.MAX_PROTEIN_G_PER_KG_PRETERM : SAFETY_LIMITS.MAX_PROTEIN_G_PER_KG_TERM;
            
            if (targetProtein_kg > max_protein_limit) {
                alerts.push({ type: 'warning', message: `M·ª•c ti√™u Protein (${targetProtein_kg.toFixed(1)} g/kg) v∆∞·ª£t qu√° gi·ªõi h·∫°n (${max_protein_limit} g/kg) cho b·ªánh nh√¢n ${patientType === 'preterm' ? 'sinh non' : 'ƒë·ªß th√°ng'}. ƒê√£ t·ª± ƒë·ªông GI·∫¢M.` });
                targetProtein_kg = max_protein_limit;
                inTargetProtein.value = max_protein_limit.toFixed(1); // C·∫≠p nh·∫≠t l·∫°i UI
            }

            if (targetLipid_kg > SAFETY_LIMITS.MAX_LIPID_G_PER_KG) {
                 alerts.push({ type: 'danger', message: `VI PH·∫†M AN TO√ÄN: Li·ªÅu Lipid m·ª•c ti√™u (${targetLipid_kg} g/kg/ng√†y) v∆∞·ª£t qu√° gi·ªõi h·∫°n an to√†n (${SAFETY_LIMITS.MAX_LIPID_G_PER_KG} g/kg/ng√†y). ƒê√£ t·ª± ƒë·ªông GI·∫¢M.` });
                targetLipid_kg = SAFETY_LIMITS.MAX_LIPID_G_PER_KG; // Gi·∫£m v·ªÅ m·ª©c an to√†n
                inTargetLipid.value = targetLipid_kg.toFixed(1); // C·∫≠p nh·∫≠t UI
            }

            // 3. T√≠nh to√°n ƒë√≥ng g√≥p c·ªßa EN (Nu√¥i ƒÉn Ti√™u h√≥a)
            const en_protein_g_kg = (milkType.protein / 100) * enVolume_kg;
            const en_kcal_kg = (milkType.kcal / 100) * enVolume_kg;

            // 4. T√≠nh to√°n nhu c·∫ßu PN (Nu√¥i ƒÉn Tƒ©nh m·∫°ch)
            
            let pn_volume_ml_kg = targetFluid_kg - enVolume_kg;
            if (pn_volume_ml_kg < 0) pn_volume_ml_kg = 0;
            const total_iv_fluid_ml = pn_volume_ml_kg * weight; 

            let pn_protein_g_kg = targetProtein_kg - en_protein_g_kg;
            if (pn_protein_g_kg < 0) pn_protein_g_kg = 0;
            
            let pn_lipid_g_kg = targetLipid_kg; 
            
            const pn_lipid_g_total = pn_lipid_g_kg * weight;
            
            const lipid_ml = pn_lipid_g_total / STOCK_SOLUTIONS.LIPID.conc;
            let pn_solution_volume_ml = total_iv_fluid_ml - lipid_ml; 
            
            if (pn_solution_volume_ml < 0) {
                alerts.push({ type: 'danger', message: 'VI PH·∫†M TH·ªÇ T√çCH: Th·ªÉ t√≠ch Lipid ƒë√£ v∆∞·ª£t qu√° t·ªïng d·ªãch Tƒ©nh m·∫°ch. Kh√¥ng th·ªÉ pha d·ªãch.' });
                pn_solution_volume_ml = 0;
            }

            const pn_lipid_kcal = pn_lipid_g_total * STOCK_SOLUTIONS.LIPID.kcal_per_g;

            const target_total_kcal = targetEnergy_kg * weight;
            const en_total_kcal = en_kcal_kg * weight;
            
            // --- B∆Ø·ªöC 4A: (PRIORITY 1) T√çNH TO√ÅN V√Ä GI·ªöI H·∫†N DEXTROSE (THEO GIR, N·ªíNG ƒê·ªò) ---
            
            const target_pn_protein_g = pn_protein_g_kg * weight;
            const target_pn_protein_kcal = target_pn_protein_g * STOCK_SOLUTIONS.AMINO_ACID.kcal_per_g;
            const target_pn_npe_kcal = (target_total_kcal - en_total_kcal) - target_pn_protein_kcal;
            let target_pn_dextrose_kcal = target_pn_npe_kcal - pn_lipid_kcal;
            if (target_pn_dextrose_kcal < 0) target_pn_dextrose_kcal = 0;
            
            let target_pn_dextrose_g = target_pn_dextrose_kcal / STOCK_SOLUTIONS.DEXTROSE_10.kcal_per_g;

            const pn_non_lipid_volume = pn_solution_volume_ml; 
            const max_dex_conc = (ivLine === 'peripheral') ? SAFETY_LIMITS.MAX_DEX_CONC_PERIPHERAL : SAFETY_LIMITS.MAX_DEX_CONC_CENTRAL;

            const max_g_by_gir = (SAFETY_LIMITS.MAX_GIR * weight * 1440) / 1000;
            let max_g_by_conc = 0;
            if (pn_non_lipid_volume > 0) {
                 max_g_by_conc = pn_non_lipid_volume * max_dex_conc;
            } else {
                 max_g_by_conc = 0; 
            }

            let pn_dextrose_g_safe = target_pn_dextrose_g;
            
            if (pn_dextrose_g_safe > max_g_by_gir) {
                alerts.push({ type: 'danger', message: `VI PH·∫†M GIR: M·ª•c ti√™u NƒÉng l∆∞·ª£ng Dextrose (${target_pn_dextrose_g.toFixed(1)}g) v∆∞·ª£t qu√° gi·ªõi h·∫°n GIR (${max_g_by_gir.toFixed(1)}g). ƒê√£ t·ª± ƒë·ªông GI·∫¢M.` });
                pn_dextrose_g_safe = max_g_by_gir;
            }

            if (pn_dextrose_g_safe > max_g_by_conc) {
                alerts.push({ type: 'danger', message: `VI PH·∫†M N·ªíNG ƒê·ªò: M·ª•c ti√™u NƒÉng l∆∞·ª£ng Dextrose (${pn_dextrose_g_safe.toFixed(1)}g) v∆∞·ª£t qu√° gi·ªõi h·∫°n n·ªìng ƒë·ªô ${ivLine === 'peripheral' ? 'Ngo·∫°i vi' : 'Trung t√¢m'} (${max_g_by_conc.toFixed(1)}g) trong th·ªÉ t√≠ch d·ªãch pha ${pn_non_lipid_volume.toFixed(0)}ml. ƒê√£ t·ª± ƒë·ªông GI·∫¢M.` });
                pn_dextrose_g_safe = max_g_by_conc;
            }
            
            const pn_dextrose_kcal_safe = pn_dextrose_g_safe * STOCK_SOLUTIONS.DEXTROSE_10.kcal_per_g;

            // --- B∆Ø·ªöC 4B: (PRIORITY 2) GI·ªöI H·∫†N PROTEIN D·ª∞A TR√äN NPE AN TO√ÄN ---
            const final_safe_pn_npe_kcal = pn_dextrose_kcal_safe + pn_lipid_kcal;
            let pn_protein_g_total_final = target_pn_protein_g; 

            const max_safe_protein_g_by_npe = final_safe_pn_npe_kcal / 25; 
            
            if (target_pn_protein_g > 0 && target_pn_protein_g > max_safe_protein_g_by_npe) {
                const pe_ratio = (target_pn_protein_g > 0) ? (final_safe_pn_npe_kcal / target_pn_protein_g) : 0;
                
                alerts.push({ 
                    type: 'danger', 
                    message: `VI PH·∫†M T·ª∂ L·ªÜ P/E: NƒÉng l∆∞·ª£ng phi-protein (PN) an to√†n (${final_safe_pn_npe_kcal.toFixed(0)} kcal) kh√¥ng ƒë·ªß cho m·ª•c ti√™u Protein (PN) (${target_pn_protein_g.toFixed(1)}g) (T·ª∑ l·ªá ${pe_ratio.toFixed(0)}:1 < 25:1). ƒê√£ t·ª± ƒë·ªông GI·∫¢M Protein (PN) xu·ªëng ${max_safe_protein_g_by_npe.toFixed(1)}g.` 
                });

                pn_protein_g_total_final = max_safe_protein_g_by_npe;
            }

            const pn_protein_kcal_final = pn_protein_g_total_final * STOCK_SOLUTIONS.AMINO_ACID.kcal_per_g;
            
            // --- C·∫¨P NH·∫¨T LOGIC T√çNH ƒêI·ªÜN GI·∫¢I (B∆Ø·ªöC 5) ---
            const amino_acid_ml = pn_protein_g_total_final / STOCK_SOLUTIONS.AMINO_ACID.conc;

            const p_ml = (targetP_kg * weight) / ELECTROLYTES.PHOSPHORUS.mmol_per_ml;
            const na_from_p_mEq = p_ml * ELECTROLYTES.PHOSPHORUS.mEqNa_per_ml;
            const total_na_target_mEq = targetNa_kg * weight;
            
            let na_needed_from_nacl_mEq = total_na_target_mEq - na_from_p_mEq;
            if (na_needed_from_nacl_mEq < 0) {
                alerts.push({ type: 'warning', message: `L∆∞·ª£ng Natri t·ª´ Phosphorus (${na_from_p_mEq.toFixed(1)} mEq) ƒë√£ v∆∞·ª£t qu√° t·ªïng m·ª•c ti√™u Natri (${total_na_target_mEq.toFixed(1)} mEq). Kh√¥ng c·∫ßn th√™m NaCl.` });
                na_needed_from_nacl_mEq = 0;
            }

            const na_ml = na_needed_from_nacl_mEq / ELECTROLYTES.NA_CL.mEq_per_ml;
            const k_ml = (targetK_kg * weight) / ELECTROLYTES.K_CL.mEq_per_ml;
            const ca_ml = (targetCa_kg * weight) / ELECTROLYTES.CA_GLUCONATE.mEq_per_ml;
            
            let pn_dextrose_g_to_use = pn_dextrose_g_safe; 
            
            // 6. T√≠nh to√°n Th·ªÉ t√≠ch Dextrose (Logic pha D10 v√† D30)
            let d10_ml = 0;
            let d30_ml = 0;
            
            const non_dextrose_volume = amino_acid_ml + na_ml + k_ml + ca_ml + p_ml;
            let available_volume_for_dextrose = pn_solution_volume_ml - non_dextrose_volume;

            let achieved_pn_dextrose_g = 0;

            if (available_volume_for_dextrose < 0) {
                alerts.push({ type: 'danger', message: 'VI PH·∫†M TH·ªÇ T√çCH: Th·ªÉ t√≠ch (AA, Lytes) v∆∞·ª£t qu√° T·ªïng d·ªãch pha. Kh√¥ng th·ªÉ th√™m Dextrose.' });
                available_volume_for_dextrose = 0;
            } else if (pn_dextrose_g_to_use <= 0) {
                d10_ml = 0;
            } else {
                
                d30_ml = (pn_dextrose_g_to_use - (0.10 * available_volume_for_dextrose)) / 0.20;
                
                if (d30_ml < 0) {
                    d30_ml = 0;
                    d10_ml = available_volume_for_dextrose;
                    alerts.push({ type: 'warning', message: 'M·ª•c ti√™u Dextrose qu√° th·∫•p (c·∫ßn <10%). ƒê√£ d√πng D10, nh∆∞ng c√≥ th·ªÉ kh√¥ng ƒë·∫°t m·ª•c ti√™u gram.' });
                } else if (d30_ml > available_volume_for_dextrose) {
                    d30_ml = available_volume_for_dextrose;
                    d10_ml = 0;
                    alerts.push({ type: 'warning', message: 'M·ª•c ti√™u Dextrose qu√° cao (c·∫ßn >30%). ƒê√£ d√πng D30, nh∆∞ng c√≥ th·ªÉ kh√¥ng ƒë·∫°t m·ª•c ti√™u gram.' });
                } else {
                    d10_ml = available_volume_for_dextrose - d30_ml;
                }
            }
            
            achieved_pn_dextrose_g = (d10_ml * STOCK_SOLUTIONS.DEXTROSE_10.conc) + (d30_ml * STOCK_SOLUTIONS.DEXTROSE_30.conc);

            // 7. T√≠nh to√°n T·ªïng k·∫øt v√† C√°c ch·ªâ s·ªë An to√†n
            const achieved_pn_dextrose_kcal = achieved_pn_dextrose_g * STOCK_SOLUTIONS.DEXTROSE_10.kcal_per_g;
            const achieved_pn_kcal = achieved_pn_dextrose_kcal + pn_protein_kcal_final + pn_lipid_kcal;
            const achieved_total_kcal = en_total_kcal + achieved_pn_kcal;
            const achieved_total_kcal_kg = achieved_total_kcal / weight;

            const en_total_protein_g = en_protein_g_kg * weight;
            const achieved_total_protein_g = en_total_protein_g + pn_protein_g_total_final;
            const achieved_total_protein_g_kg = achieved_total_protein_g / weight;

            const achieved_total_lipid_g_kg = pn_lipid_g_kg; 

            const gir = (achieved_pn_dextrose_g * 1000) / (weight * 1440);

            let dextrose_concentration = 0;
            if (pn_non_lipid_volume > 0) {
                dextrose_concentration = achieved_pn_dextrose_g / pn_non_lipid_volume;
            }

            // 8. Ki·ªÉm tra C·∫£nh b√°o An to√†n (Sau khi t√≠nh to√°n)
            
            // KI·ªÇM TRA N·ªíNG ƒê·ªò AMINO ACID NGO·∫†I VI√äN
            let aa_concentration = 0;
            if (pn_non_lipid_volume > 0) { 
                aa_concentration = pn_protein_g_total_final / pn_non_lipid_volume;
            }

            if (ivLine === 'peripheral' && aa_concentration > SAFETY_LIMITS.MAX_AA_CONC_PERIPHERAL) {
                alerts.push({ 
                    type: 'danger', 
                    message: `VI PH·∫†M N·ªíNG ƒê·ªò AA: N·ªìng ƒë·ªô Amino Acid (${(aa_concentration * 100).toFixed(1)}%) v∆∞·ª£t qu√° gi·ªõi h·∫°n ngo·∫°i vi (${(SAFETY_LIMITS.MAX_AA_CONC_PERIPHERAL * 100).toFixed(0)}%). C√¢n nh·∫Øc ƒë∆∞·ªùng truy·ªÅn trung t√¢m ho·∫∑c gi·∫£m Protein.` 
                });
            }

            if (achieved_pn_dextrose_g < (pn_dextrose_g_safe - 0.1)) { 
                const achieved_pn_npe_kcal = achieved_pn_dextrose_kcal + pn_lipid_kcal;
                const required_npe = pn_protein_g_total_final * 25;
                
                if (pn_protein_g_total_final > 0 && achieved_pn_npe_kcal < required_npe) {
                    const final_pe_ratio = achieved_pn_npe_kcal / pn_protein_g_total_final;
                    alerts.push({ 
                        type: 'warning', 
                        message: `C·∫¢NH B√ÅO P/E (Th·ªÉ t√≠ch): Do gi·ªõi h·∫°n th·ªÉ t√≠ch pha Dextrose, NƒÉng l∆∞·ª£ng phi-protein th·ª±c t·∫ø (${achieved_pn_npe_kcal.toFixed(0)} kcal) th·∫•p h∆°n m·ª©c t·ªëi ∆∞u cho Protein (${pn_protein_g_total_final.toFixed(1)}g). T·ª∑ l·ªá P/E th·ª±c t·∫ø l√† ${final_pe_ratio.toFixed(0)}:1.` 
                    });
                }
            }

            if (enVolume_kg >= SAFETY_LIMITS.EN_STOP_PN_THRESHOLD) {
                 alerts.push({ type: 'info', message: `Th·ªÉ t√≠ch EN (${enVolume_kg} ml/kg/ng√†y) ƒë√£ ƒë·∫°t ng∆∞·ª°ng >= ${SAFETY_LIMITS.EN_STOP_PN_THRESHOLD} ml/kg/ng√†y. C√¢n nh·∫Øc ng∆∞ng PN.` });
            }

            if (alerts.length === 0) {
                alerts.push({ type: 'success', message: 'T·∫•t c·∫£ c√°c ch·ªâ s·ªë ƒë·ªÅu trong gi·ªõi h·∫°n an to√†n.' });
            }
            
            // 9. T√≠nh to√°n cho B·∫£ng Ph√¢n t√≠ch Chi ti·∫øt
            const en_protein_kcal = en_total_protein_g * STOCK_SOLUTIONS.AMINO_ACID.kcal_per_g;
            const en_npe_kcal = en_total_kcal - en_protein_kcal;
            const en_ratio = (en_total_protein_g > 0) ? (en_npe_kcal / en_total_protein_g) : 0;
            
            const pn_protein_kcal = pn_protein_kcal_final; 
            const pn_npe_kcal = achieved_pn_dextrose_kcal + pn_lipid_kcal;
            const pn_ratio = (pn_protein_g_total_final > 0) ? (pn_npe_kcal / pn_protein_g_total_final) : 0;
            
            const total_protein_g = achieved_total_protein_g;
            const total_protein_kcal = total_protein_g * STOCK_SOLUTIONS.AMINO_ACID.kcal_per_g;
            const total_npe_kcal = achieved_total_kcal - total_protein_kcal;
            const total_ratio = (total_protein_g > 0) ? (total_npe_kcal / total_protein_g) : 0;
            
            const pn_dextrose_g_kg = (weight > 0) ? (achieved_pn_dextrose_g / weight) : 0;
            const pn_lipid_g_kg_final = (weight > 0) ? (pn_lipid_g_total / weight) : 0;


            // 10. HI·ªÇN TH·ªä K·∫æT QU·∫¢
            
            // --- LOGIC L√ÄM TR√íN ƒê·ªÇ HI·ªÇN TH·ªä PHA CH·∫æ ---
            
            const amino_acid_ml_rounded = roundToTen(amino_acid_ml);
            const d10_ml_rounded = roundToTen(d10_ml);
            const d30_ml_rounded = roundToTen(d30_ml);
            const na_ml_rounded = roundToHalf(na_ml);
            const k_ml_rounded = roundToHalf(k_ml);
            const ca_ml_rounded = roundToHalf(ca_ml);
            const p_ml_rounded = roundToHalf(p_ml); 

            const pn_solution_volume_rounded = amino_acid_ml_rounded + d10_ml_rounded + d30_ml_rounded + na_ml_rounded + k_ml_rounded + ca_ml_rounded + p_ml_rounded;
            
            const rate_solution_rounded = roundToUnit(pn_solution_volume_rounded / 24);

            const lipid_ml_rounded = roundToUnit(lipid_ml);
            const rate_lipid_rounded = roundToUnit(lipid_ml_rounded / 24);

            // A. Kh·ªëi T·ªïng k·∫øt
            resTotalFluid.textContent = `${(enVolume_kg + pn_volume_ml_kg).toFixed(0)} ml/kg/ng√†y`;
            resTotalEnergy.textContent = `${achieved_total_kcal_kg.toFixed(0)} kcal/kg/ng√†y`;
            resTotalProtein.textContent = `${achieved_total_protein_g_kg.toFixed(1)} g/kg/ng√†y`;
            resTotalLipid.textContent = `${achieved_total_lipid_g_kg.toFixed(1)} g/kg/ng√†y`;
            resGIR.textContent = `${gir.toFixed(1)} mg/kg/ph√∫t`;
            resDextroseConc.textContent = `${(dextrose_concentration * 100).toFixed(1)} %`;

            // B. Kh·ªëi Th√†nh ph·∫ßn Pha
            resPnTotalVolume.textContent = `${pn_solution_volume_rounded.toFixed(1)} ml`;
            resAminoAcidML.textContent = `${amino_acid_ml_rounded.toFixed(1)} ml`;
            resDextrose10ML.textContent = `${d10_ml_rounded.toFixed(1)} ml`;
            resDextrose30ML.textContent = `${d30_ml_rounded.toFixed(1)} ml`;
            resNaML.textContent = `${na_ml_rounded.toFixed(1)} ml`;
            resKML.textContent = `${k_ml_rounded.toFixed(1)} ml`;
            resCaML.textContent = `${ca_ml_rounded.toFixed(1)} ml`;
            resPML.textContent = `${p_ml_rounded.toFixed(1)} ml`; 
            
            resLipidML_sep.textContent = `${lipid_ml_rounded.toFixed(1)} ml`;
            resRateSolution.textContent = `${rate_solution_rounded.toFixed(0)} ml/gi·ªù`;
            resRateLipid.textContent = `${rate_lipid_rounded.toFixed(0)} ml/gi·ªù`;

            // C. B·∫£ng T√≥m t·∫Øt
            sumEnKcal.textContent = en_kcal_kg.toFixed(0);
            sumPnKcal.textContent = (weight > 0 ? (achieved_pn_kcal / weight) : 0).toFixed(0);
            sumTotalKcal.textContent = achieved_total_kcal_kg.toFixed(0);
            
            sumEnProtein.textContent = en_protein_g_kg.toFixed(1);
            sumPnProtein.textContent = (weight > 0 ? (pn_protein_g_total_final / weight) : 0).toFixed(1);
            sumTotalProtein.textContent = achieved_total_protein_g_kg.toFixed(1);

            sumEnLipid.textContent = '0.0'; 
            sumPnLipid.textContent = pn_lipid_g_kg_final.toFixed(1);
            sumTotalLipid_g.textContent = (pn_lipid_g_kg_final + 0.0).toFixed(1); 
            
            sumEnDextrose.textContent = '0.0'; 
            sumPnDextrose.textContent = pn_dextrose_g_kg.toFixed(1);
            sumTotalDextrose.textContent = (pn_dextrose_g_kg + 0.0).toFixed(1); 

            sumEnRatio.textContent = en_ratio.toFixed(0);
            sumPnRatio.textContent = pn_ratio.toFixed(0);
            sumTotalRatio.textContent = total_ratio.toFixed(0);

            // D. C·∫≠p nh·∫≠t C·∫£nh b√°o
            updateAlerts(alerts);
            
            // --- *** M·ªöI: K√çCH HO·∫†T N√öT AI *** ---
            analyzeBtn.disabled = false;
            aiAnalysisResult.innerHTML = '<p class="text-gray-500 italic">Nh·∫•n n√∫t tr√™n ƒë·ªÉ nh·∫≠n ph√¢n t√≠ch AI cho k·∫øt qu·∫£ n√†y.</p>';
        }

        // --- H√†m H·ªó tr·ª£ ---

        function roundToUnit(value) {
            return Math.round(value);
        }
        function roundToTen(value) {
            return Math.round(value / 10) * 10;
        }
        function roundToHalf(value) {
            return Math.round(value * 2) / 2;
        }

        function updateAlerts(alerts) {
            alertsContainer.innerHTML = ''; // X√≥a c·∫£nh b√°o c≈©
            if (alerts.length === 0) {
                alertsContainer.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ c·∫£nh b√°o.</p>';
                return;
            }
            
            alerts.sort((a, b) => {
                const order = { danger: 0, warning: 1, info: 2, success: 3 };
                return order[a.type] - order[b.type];
            });

            alerts.forEach(alert => {
                alertsContainer.innerHTML += buildAlertHTML(alert.type, alert.message);
            });
        }

        function buildAlertHTML(type, message) {
            let bgColor, borderColor, textColor, icon;
            switch (type) {
                case 'danger':
                    bgColor = 'bg-red-100'; borderColor = 'border-red-500'; textColor = 'text-red-700'; icon = '‚ö†Ô∏è';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-100'; borderColor = 'border-yellow-500'; textColor = 'text-yellow-700'; icon = 'üîî';
                    break;
                case 'info':
                    bgColor = 'bg-blue-100'; borderColor = 'border-blue-500'; textColor = 'text-blue-700'; icon = '‚ÑπÔ∏è';
                    break;
                case 'success':
                    bgColor = 'bg-green-100'; borderColor = 'border-green-500'; textColor = 'text-green-700'; icon = '‚úÖ';
                    break;
            }
            
            return `
                <div class="${bgColor} border-l-4 ${borderColor} ${textColor} p-4 rounded-md" role="alert">
                    <p class="font-bold">${icon} ${type.charAt(0).toUpperCase() + type.slice(1)}</p>
                    <p>${message}</p>
                </div>
            `;
        }

        // --- *** M·ªöI: C√ÅC H√ÄM T√çCH H·ª¢P GEMINI AI *** ---

        /**
         * H√†m t·∫°m d·ª´ng (sleep)
         */
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /**
         * H√†m g·ªçi API Gemini v·ªõi logic th·ª≠ l·∫°i (exponential backoff)
         */
        async function callGeminiAPI(userPrompt, systemPrompt, retries = 5, delay = 1000) {
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // N·∫øu l·ªói 5xx (l·ªói server) th√¨ th·ª≠ l·∫°i
                        if (response.status >= 500) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                        // L·ªói 4xx (l·ªói client) th√¨ kh√¥ng th·ª≠ l·∫°i, b√°o l·ªói ngay
                        const errorData = await response.json();
                        console.error("Gemini API Error (4xx):", errorData);
                        return `L·ªói API: ${errorData.error?.message || response.statusText}`;
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                        return "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung h·ª£p l·ªá t·ª´ AI. Vui l√≤ng th·ª≠ l·∫°i.";
                    }

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < retries - 1) {
                        await sleep(delay);
                        delay *= 2; // TƒÉng th·ªùi gian ch·ªù (exponential backoff)
                    } else {
                        return `ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi ƒë·∫øn AI sau ${retries} l·∫ßn th·ª≠: ${error.message}`;
                    }
                }
            }
        }

        /**
         * H√†m ch√≠nh ƒë·ªÉ thu th·∫≠p d·ªØ li·ªáu v√† g·ªçi AI
         */
        async function getAIAnalysis() {
            analyzeBtn.disabled = true;
            aiAnalysisResult.innerHTML = '<div class="loader"></div><p class="text-center text-indigo-600">AI ƒëang ph√¢n t√≠ch, vui l√≤ng ch·ªù...</p>';

            // 1. Thu th·∫≠p to√†n b·ªô d·ªØ li·ªáu
            const data = {
                // Th√¥ng tin b·ªánh nh√¢n
                weight: inWeight.value,
                patientType: inPatientType.options[inPatientType.selectedIndex].text,
                ivLine: inIvLine.options[inIvLine.selectedIndex].text,
                
                // M·ª•c ti√™u
                targetFluid: inTargetFluid.value,
                targetEnergy: inTargetEnergy.value,
                targetProtein: inTargetProtein.value,
                targetLipid: inTargetLipid.value,
                enVolume: inEnVolume.value,

                // K·∫øt qu·∫£ ƒë·∫°t ƒë∆∞·ª£c
                resTotalFluid: resTotalFluid.textContent,
                resTotalEnergy: resTotalEnergy.textContent,
                resTotalProtein: resTotalProtein.textContent,
                resTotalLipid: resTotalLipid.textContent,
                resGIR: resGIR.textContent,
                resDextroseConc: resDextroseConc.textContent,

                // C√°c c·∫£nh b√°o
                alerts: Array.from(alertsContainer.querySelectorAll('div[role="alert"]'))
                             .map(div => div.innerText.replace(/[\n\r]+|\s{2,}/g, ' ').trim())
                             .join('; ')
            };

            // 2. ƒê·ªãnh nghƒ©a System Prompt (Ch·ªâ th·ªã h·ªá th·ªëng)
            const systemPrompt = `B·∫°n l√† m·ªôt chuy√™n gia y t·∫ø, b√°c sƒ© chuy√™n khoa s√¢u v·ªÅ dinh d∆∞·ª°ng s∆° sinh, l√†m vi·ªác t·∫°i m·ªôt b·ªánh vi·ªán l·ªõn. 
B·∫°n nh·∫≠n ƒë∆∞·ª£c m·ªôt b·∫£ng k·∫øt qu·∫£ t√≠nh to√°n dinh d∆∞·ª°ng (PN/EN) cho m·ªôt b·ªánh nhi.
Nhi·ªám v·ª• c·ªßa b·∫°n l√† ph√¢n t√≠ch d·ªØ li·ªáu ƒë∆∞·ª£c cung c·∫•p v√† ƒë∆∞a ra m·ªôt b·∫£n t√≥m t·∫Øt ng·∫Øn g·ªçn (kho·∫£ng 3-5 c√¢u) mang t√≠nh h·ªó tr·ª£ quy·∫øt ƒë·ªãnh l√¢m s√†ng.

QUY T·∫ÆC:
1.  **T·∫≠p trung v√†o c√°c c·∫£nh b√°o:** Lu√¥n b·∫Øt ƒë·∫ßu b·∫±ng c√°ch xem x√©t c√°c "C·∫¢NH B√ÅO" ƒë∆∞·ª£c cung c·∫•p. ƒê√¢y l√† th√¥ng tin quan tr·ªçng nh·∫•t.
2.  **ƒê√°nh gi√° c√°c ch·ªâ s·ªë ch√≠nh:** Nh·∫≠n x√©t v·ªÅ c√°c ch·ªâ s·ªë an to√†n quan tr·ªçng nh∆∞ GIR (T·ªëc ƒë·ªô truy·ªÅn Glucose) v√† N·ªìng ƒë·ªô Dextrose, N·ªìng ƒë·ªô Amino Acid (n·∫øu c√≥ vi ph·∫°m).
3.  **So s√°nh m·ª•c ti√™u v√† k·∫øt qu·∫£:** Ch·ªâ ra b·∫•t k·ª≥ s·ª± kh√°c bi·ªát ƒë√°ng k·ªÉ n√†o gi·ªØa "M·ª•c ti√™u" v√† "K·∫øt qu·∫£ ƒë·∫°t ƒë∆∞·ª£c" (v√≠ d·ª•: kh√¥ng ƒë·∫°t ƒë∆∞·ª£c nƒÉng l∆∞·ª£ng ho·∫∑c protein m·ª•c ti√™u).
4.  **Gi·ªçng ƒëi·ªáu:** Chuy√™n nghi·ªáp, ng·∫Øn g·ªçn, v√† mang t√≠nh h·ªçc thu·∫≠t y khoa.
5.  **Ng√¥n ng·ªØ:** Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát.`;

            // 3. ƒê·ªãnh nghƒ©a User Prompt (D·ªØ li·ªáu ƒë·∫ßu v√†o)
            const userPrompt = `D∆∞·ªõi ƒë√¢y l√† d·ªØ li·ªáu t√≠nh to√°n dinh d∆∞·ª°ng cho m·ªôt b·ªánh nhi s∆° sinh, vui l√≤ng ph√¢n t√≠ch:

**1. TH√îNG TIN B·ªÜNH NH√ÇN:**
* C√¢n n·∫∑ng: ${data.weight} kg
* ƒê·ªëi t∆∞·ª£ng: ${data.patientType}
* ƒê∆∞·ªùng truy·ªÅn: ${data.ivLine}

**2. M·ª§C TI√äU (ƒë∆°n v·ªã /kg/ng√†y):**
* T·ªïng d·ªãch: ${data.targetFluid} ml
* NƒÉng l∆∞·ª£ng: ${data.targetEnergy} kcal
* Protein: ${data.targetProtein} g
* Lipid: ${data.targetLipid} g
* Th·ªÉ t√≠ch EN: ${data.enVolume} ml

**3. K·∫æT QU·∫¢ ƒê·∫†T ƒê∆Ø·ª¢C (T·ªîNG /kg/ng√†y):**
* T·ªïng d·ªãch: ${data.resTotalFluid}
* T·ªïng NƒÉng l∆∞·ª£ng: ${data.resTotalEnergy}
* T·ªïng Protein: ${data.resTotalProtein}
* T·ªïng Lipid: ${data.resTotalLipid}

**4. C√ÅC CH·ªà S·ªê PN QUAN TR·ªåNG:**
* T·ªëc ƒë·ªô truy·ªÅn Glucose (GIR): ${data.resGIR}
* N·ªìng ƒë·ªô Dextrose (PN): ${data.resDextroseConc}

**5. C√ÅC C·∫¢NH B√ÅO T·ª™ H·ªÜ TH·ªêNG T√çNH TO√ÅN:**
* ${data.alerts.length > 0 ? data.alerts : "Kh√¥ng c√≥ c·∫£nh b√°o n√†o."}

**Y√äU C·∫¶U:** D·ª±a tr√™n vai tr√≤ c·ªßa b·∫°n v√† c√°c quy t·∫Øc, h√£y cung c·∫•p m·ªôt b·∫£n ph√¢n t√≠ch ng·∫Øn g·ªçn v·ªÅ t√¨nh hu·ªëng n√†y.
`;

            // 4. G·ªçi API
            const analysisText = await callGeminiAPI(userPrompt, systemPrompt);

            // 5. Hi·ªÉn th·ªã k·∫øt qu·∫£
            // Chuy·ªÉn ƒë·ªïi Markdown c∆° b·∫£n (nh∆∞ *item*) sang HTML
            let formattedText = analysisText
                .replace(/\n\*/g, '<br>‚Ä¢') // Thay * ƒë·∫ßu d√≤ng cho list
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic
                .replace(/\n/g, '<br>'); // Newlines

            if (analysisText.startsWith("L·ªói") || analysisText.startsWith("ƒê√£ x·∫£y ra l·ªói")) {
                 aiAnalysisResult.innerHTML = `<p class="text-red-600 font-medium">${formattedText}</p>`;
            } else {
                 aiAnalysisResult.innerHTML = `<div class="prose prose-sm max-w-none">${formattedText}</div>`;
            }
           
            analyzeBtn.disabled = false;
        }


        // T·ª± ƒë·ªông ch·∫°y t√≠nh to√°n l·∫ßn ƒë·∫ßu khi t·∫£i trang
        document.addEventListener('DOMContentLoaded', () => {
            calculateNutrition();
            // Th√™m event listener cho n√∫t AI
            analyzeBtn.addEventListener('click', getAIAnalysis);
        });

        // Th√™m event listener cho t·∫•t c·∫£ input ƒë·ªÉ t·ª± ƒë·ªông t√≠nh to√°n
        document.querySelectorAll('input, select').forEach(item => {
            item.addEventListener('change', calculateNutrition);
        });

    </script>
</body>
</html>